From 9ae300030b796fc7c18cbe6f3e1dbe2d8abf347d Mon Sep 17 00:00:00 2001
From: mystri <mystri@noreply.gitcode.com>
Date: Tue, 2 Dec 2025 00:38:07 +0800
Subject: [PATCH] Integrated SAM spec decoding into vllm-ascend

---
 .../patch/platform/patch_common/patch_config.py        | 10 +++++++---
 qwen3/vllm_ascend/spec_decode/__init__.py              |  3 +++
 qwen3/vllm_ascend/spec_decode/interface.py             |  1 +
 3 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/llm_rl/qwen3/vllm_ascend/patch/platform/patch_common/patch_config.py b/llm_rl/qwen3/vllm_ascend/patch/platform/patch_common/patch_config.py
index 9b6f5c2..274338b 100644
--- a/llm_rl/qwen3/vllm_ascend/patch/platform/patch_common/patch_config.py
+++ b/llm_rl/qwen3/vllm_ascend/patch/platform/patch_common/patch_config.py
@@ -106,6 +106,8 @@ def __post_init__(self):
                 self.quantization = self.target_model_config.quantization
         elif self.method in ("ngram", "[ngram]"):
             self.model = "ngram"
+        elif self.method == "sam":
+            self.model = "sam"
         else:
             raise ValueError("num_speculative_tokens was provided but without "
                              "speculative model.")
@@ -116,9 +118,11 @@ def __post_init__(self):
                                 and self.model in ("ngram", "[ngram]")):
         self.method = "ngram"
 
-    if self.method in ("ngram", "[ngram]"):
-        # Unified to "ngram" internally
-        self.method = "ngram"
+    # Patch: setup parameters for model-free methods.
+    if self.method in ("ngram", "[ngram]", "sam"):
+        if self.method in ("ngram", "[ngram]"):
+            # Unified to "ngram" internally
+            self.method = "ngram"
         # Set default values if not provided
         if (self.prompt_lookup_min is None and self.prompt_lookup_max is None):
             # TODO(woosuk): Tune these values. They are arbitrarily chosen.
diff --git a/llm_rl/qwen3/vllm_ascend/spec_decode/__init__.py b/llm_rl/qwen3/vllm_ascend/spec_decode/__init__.py
index 64076c2..f31affc 100644
--- a/llm_rl/qwen3/vllm_ascend/spec_decode/__init__.py
+++ b/llm_rl/qwen3/vllm_ascend/spec_decode/__init__.py
@@ -19,9 +19,12 @@
 from vllm_ascend.spec_decode.eagle_proposer import EagleProposer
 from vllm_ascend.spec_decode.mtp_proposer import MtpProposer
 from vllm_ascend.spec_decode.ngram_proposer import NgramProposer
+from patches.vllm_ascend.spec_decode.sam_proposer import SAMProposer
 
 
 def get_spec_decode_method(method, vllm_config, device, runner):
+    if method == "sam":
+        return SAMProposer(vllm_config, device, runner)
     if method == "ngram":
         return NgramProposer(vllm_config, device, runner)
     elif method in ["eagle", "eagle3"]:
diff --git a/llm_rl/qwen3/vllm_ascend/spec_decode/interface.py b/llm_rl/qwen3/vllm_ascend/spec_decode/interface.py
index 0efe93d..9ec115f 100644
--- a/llm_rl/qwen3/vllm_ascend/spec_decode/interface.py
+++ b/llm_rl/qwen3/vllm_ascend/spec_decode/interface.py
@@ -13,6 +13,7 @@ class SpecDcodeType(enum.Enum):
     EAGLE = 1
     EAGLE3 = 2
     MTP = 4
+    SAM = 5
 
 
 class Proposer:
-- 
2.28.0.windows.1

